<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Alimentos - DMTool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Estilos base do projeto */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9fafb;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      background-color: #2563eb;
      color: white;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    #nomeUsuario {
      font-size: 14px;
      opacity: 0.8;
      text-align: right;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 20px;
      position: relative;
      overflow-y: auto;
    }

    /* Estilos do conteúdo da página */
    .container {
      width: 100%;
      max-width: 600px;
    }

    h2 {
      text-align: center;
      color: #333;
      margin-top: 0;
      margin-bottom: 20px;
    }

    #searchBar {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      margin-bottom: 20px;
    }

    .lista-alimentos-container {
      width: 100%;
      height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .alimento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .alimento-item:hover {
      background-color: #f3f4f6;
    }

    .alimento-item.selected {
      background-color: #d1fae5;
      border-color: #10b981;
    }

    .alimento-nome {
      font-weight: bold;
      color: #333;
    }

    .acoes {
      display: none;
    }

    .alimento-item.selected .acoes {
      display: flex;
      gap: 10px;
    }

    .btn-acao {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: background-color 0.2s;
    }
    
    .btn-visualizar {
      background-color: #2563eb;
      color: white;
    }

    .btn-visualizar:hover {
      background-color: #1e40af;
    }

    .btn-excluir {
      background-color: #ef4444;
      color: white;
    }

    .btn-excluir:hover {
      background-color: #b91c1c;
    }
    
    /* Painel de detalhes (slide-in) */
    .detalhes-alimento-panel {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background-color: white;
      z-index: 100;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .detalhes-alimento-panel.open {
      transform: translateX(0);
    }
    
    .detalhes-alimento-panel h2 {
      margin-top: 0;
    }

    .detalhes-alimento-panel label {
      margin-top: 15px;
      display: block;
      font-weight: bold;
      color: #555;
    }

    .detalhes-alimento-panel input {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    .detalhes-alimento-panel input:disabled {
      background-color: #f3f4f6;
    }

    .detalhes-alimento-panel .botoes {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn-editar-salvar {
      padding: 12px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
    }
    .btn-editar-salvar:hover {
      background-color: #1e40af;
    }

    .btn-retornar {
      padding: 12px;
      background-color: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-retornar:hover {
      background-color: #374151;
    }

    /* Modal de confirmação */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none; /* Inicia oculto */
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 12px;
      max-width: 350px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .modal-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .modal-buttons button {
      width: 45%;
    }

    /* Botão de retorno ao menu */
    #btnVoltarMenu {
      width: 100%;
      max-width: 600px;
      padding: 12px;
      background-color: #6b7280;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.2s;
    }
    #btnVoltarMenu:hover {
      background-color: #374151;
    }
    
    /* Estilos responsivos */
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        padding: 12px;
        text-align: center;
      }
      #nomeUsuario {
        margin-top: 5px;
      }
      main {
        padding: 10px;
      }
      .alimento-item {
        padding: 12px;
      }
      .alimento-item.selected .acoes {
        flex-direction: column;
        gap: 5px;
      }
      .btn-acao {
        padding: 6px 10px;
        font-size: 12px;
      }
      .detalhes-alimento-panel {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>DMTool</h1>
    <div id="nomeUsuario">Carregando...</div>
  </header>

  <main>
    <div class="container">
      <h2>Alimentos</h2>
      
      <!-- Campo de busca -->
      <input type="text" id="searchBar" placeholder="Pesquisar alimentos..." />

      <!-- Lista de alimentos -->
      <div id="listaAlimentos" class="lista-alimentos-container hidden">
        <!-- Itens de alimentos serão injetados aqui via JS -->
      </div>
    </div>

    <!-- Botão de retorno ao menu -->
    <button id="btnVoltarMenu">Voltar para o Menu</button>
  </main>

  <!-- Painel de detalhes do alimento (inicialmente oculto) -->
  <div id="detalhesAlimento" class="detalhes-alimento-panel">
    <h2>Detalhes do Alimento</h2>
    <form id="detalhesForm">
      <label for="nomeAlimento">Nome</label>
      <input type="text" id="nomeAlimento" disabled />

      <label for="carboidratoInput">Carboidrato (g)</label>
      <input type="number" id="carboidratoInput" step="0.1" disabled />

      <label for="proteinaInput">Proteína (g)</label>
      <input type="number" id="proteinaInput" step="0.1" disabled />

      <label for="gorduraInput">Gordura (g)</label>
      <input type="number" id="gorduraInput" step="0.1" disabled />

      <label for="energiaInput">Energia (kcal)</label>
      <input type="number" id="energiaInput" step="0.1" disabled />

      <label for="quantidadeInput">Quantidade (g/ml)</label>
      <input type="number" id="quantidadeInput" step="1" disabled />
      
      <label for="medidaCaseiraInput">Medida Caseira</label>
      <input type="text" id="medidaCaseiraInput" disabled />

      <div class="botoes">
        <button type="button" id="btnEditarSalvar" class="btn-editar-salvar">Editar</button>
        <button type="button" id="btnRetornar" class="btn-retornar">Retornar</button>
      </div>
    </form>
  </div>
  
  <!-- Overlay para modais (confirmação, etc.) -->
  <div id="modalOverlay" class="modal-overlay">
    <!-- Conteúdo do modal será injetado aqui -->
  </div>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>

  <script>
    // Referências aos elementos do DOM
    const nomeUsuarioHeader = document.getElementById('nomeUsuario');
    const searchBar = document.getElementById('searchBar');
    const listaAlimentosDiv = document.getElementById('listaAlimentos');
    const detalhesAlimentoPanel = document.getElementById('detalhesAlimento');
    const detalhesForm = document.getElementById('detalhesForm');
    const nomeAlimentoInput = document.getElementById('nomeAlimento');
    const carboidratoInput = document.getElementById('carboidratoInput');
    const proteinaInput = document.getElementById('proteinaInput');
    const gorduraInput = document.getElementById('gorduraInput');
    const energiaInput = document.getElementById('energiaInput');
    const quantidadeInput = document.getElementById('quantidadeInput');
    const medidaCaseiraInput = document.getElementById('medidaCaseiraInput');
    const btnEditarSalvar = document.getElementById('btnEditarSalvar');
    const btnRetornar = document.getElementById('btnRetornar');
    const modalOverlay = document.getElementById('modalOverlay');
    const btnVoltarMenu = document.getElementById('btnVoltarMenu');

    let allAlimentos = [];
    let filteredAlimentos = [];
    let selectedFoodId = null;
    let editMode = false;
    let auth, db;
    
    // Configuração do Firebase, usando os mesmos parâmetros fornecidos
    const firebaseConfig = {
      apiKey: "AIzaSyBjyWDtsSTa8Wb162xFujBt_q3KfKlOP98",
      authDomain: "dmtool-89d0d.firebaseapp.com",
      projectId: "dmtool-89d0d",
      storageBucket: "dmtool-89d0d.appspot.com",
      messagingSenderId: "389362217807",
      appId: "1:389362217807:web:2805220ee73ce3c0c28b3a"
    };
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();

    // Função para carregar o nome do usuário a partir do Firestore
    async function carregarNomeUsuario(uid) {
      try {
        const doc = await db.collection('usuarios').doc(uid).get();
        if (doc.exists && doc.data().nome) {
          nomeUsuarioHeader.innerText = doc.data().nome;
        } else {
          nomeUsuarioHeader.innerText = "Usuário Desconhecido";
        }
      } catch (error) {
        console.error("Erro ao carregar nome do usuário:", error);
        nomeUsuarioHeader.innerText = "Erro ao carregar nome";
      }
    }

    // Listener de autenticação para carregar dados
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await carregarNomeUsuario(user.uid);
        await carregarAlimentos();
      } else {
        console.warn("Nenhum usuário logado. As funções de banco de dados podem não funcionar.");
        listaAlimentosDiv.classList.remove('hidden');
        listaAlimentosDiv.innerHTML = '<p style="text-align:center;">Nenhum usuário logado. Por favor, faça login.</p>';
      }
    });

    async function carregarAlimentos() {
      listaAlimentosDiv.classList.remove('hidden');
      try {
        db.collection('alimentos').onSnapshot(snapshot => {
          allAlimentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          filtrarAlimentos(searchBar.value);
        });
      } catch (error) {
        console.error("Erro ao carregar alimentos:", error);
      }
    }

    // Função para filtrar e renderizar a lista
    function filtrarAlimentos(query) {
      const termo = query.toLowerCase();
      filteredAlimentos = allAlimentos.filter(alimento => 
        (alimento.nome || '').toLowerCase().includes(termo)
      );
      renderAlimentos();
    }

    function renderAlimentos() {
      listaAlimentosDiv.innerHTML = '';
      if (filteredAlimentos.length === 0) {
        listaAlimentosDiv.innerHTML = '<p style="text-align:center;">Nenhum alimento encontrado.</p>';
        return;
      }
      filteredAlimentos.forEach(alimento => {
        const div = document.createElement('div');
        div.classList.add('alimento-item');
        if (alimento.id === selectedFoodId) {
          div.classList.add('selected');
        }
        div.setAttribute('data-id', alimento.id);
        
        div.innerHTML = `
          <span class="alimento-nome">${alimento.nome}</span>
          <div class="acoes">
            <button class="btn-acao btn-excluir">Excluir</button>
            <button class="btn-acao btn-visualizar">Visualizar</button>
          </div>
        `;
        
        div.addEventListener('click', () => handleAlimentoClick(alimento.id));
        div.querySelector('.btn-excluir').addEventListener('click', (e) => {
          e.stopPropagation();
          showConfirmationModal(alimento.id, alimento.nome);
        });
        div.querySelector('.btn-visualizar').addEventListener('click', (e) => {
          e.stopPropagation();
          handleVisualizarClick(alimento.id);
        });
        
        listaAlimentosDiv.appendChild(div);
      });
    }

    // Lógica para selecionar o alimento e mostrar ações
    function handleAlimentoClick(id) {
      if (selectedFoodId === id) {
        selectedFoodId = null;
      } else {
        selectedFoodId = id;
      }
      renderAlimentos();
    }

    // Lógica para visualizar detalhes do alimento
    function handleVisualizarClick(id) {
      const alimento = allAlimentos.find(a => a.id === id);
      if (alimento) {
        preencherDetalhes(alimento);
        detalhesAlimentoPanel.classList.add('open');
      }
    }
    
    // Preenche o painel de detalhes com os dados do alimento
    function preencherDetalhes(alimento) {
      nomeAlimentoInput.value = alimento.nome || '';
      carboidratoInput.value = alimento.carboidrato || '';
      proteinaInput.value = alimento.proteina || '';
      gorduraInput.value = alimento.gordura || '';
      energiaInput.value = alimento.energia || '';
      quantidadeInput.value = alimento.quantidade_g_ml || '';
      medidaCaseiraInput.value = alimento.medida_caseira || '';

      // Modo de visualização por padrão
      toggleEditMode(false);
    }
    
    // Alterna entre modo de visualização e edição
    function toggleEditMode(isEditing) {
      editMode = isEditing;
      const inputs = detalhesForm.querySelectorAll('input');
      inputs.forEach(input => {
        input.disabled = !isEditing;
      });
      btnEditarSalvar.innerText = isEditing ? 'Salvar' : 'Editar';
      btnEditarSalvar.classList.toggle('btn-salvar', isEditing);
    }

    // Lógica do botão "Retornar"
    btnRetornar.addEventListener('click', () => {
      detalhesAlimentoPanel.classList.remove('open');
      selectedFoodId = null;
      renderAlimentos();
    });

    // Lógica do botão "Editar" / "Salvar"
    btnEditarSalvar.addEventListener('click', async () => {
      if (!editMode) {
        toggleEditMode(true);
      } else {
        await salvarAlteracoes(selectedFoodId);
      }
    });

    // Salva as alterações no Firestore
    async function salvarAlteracoes(id) {
      const dadosAtualizados = {
        nome: nomeAlimentoInput.value,
        carboidrato: parseFloat(carboidratoInput.value) || 0,
        proteina: parseFloat(proteinaInput.value) || 0,
        gordura: parseFloat(gorduraInput.value) || 0,
        energia: parseFloat(energiaInput.value) || 0,
        quantidade_g_ml: parseFloat(quantidadeInput.value) || 0,
        medida_caseira: medidaCaseiraInput.value,
      };
      
      try {
        await db.collection('alimentos').doc(id).update(dadosAtualizados);
        alert('Dados atualizados com sucesso!');
        detalhesAlimentoPanel.classList.remove('open');
        selectedFoodId = null;
        toggleEditMode(false);
      } catch (error) {
        console.error("Erro ao atualizar alimento:", error);
        alert('Erro ao salvar as alterações: ' + error.message);
      }
    }
    
    // Lógica para excluir o alimento
    async function excluirAlimento(id) {
      try {
        await db.collection('alimentos').doc(id).delete();
        hideModal();
        alert('Alimento excluído com sucesso!');
        selectedFoodId = null;
        renderAlimentos();
      } catch (error) {
        console.error("Erro ao excluir alimento:", error);
        alert('Erro ao excluir o alimento: ' + error.message);
      }
    }
    
    // Modal de confirmação para exclusão
    function showConfirmationModal(id, nome) {
      modalOverlay.innerHTML = `
        <div class="modal-content">
          <h3>Confirmar Exclusão</h3>
          <p>Tem certeza que deseja excluir o alimento "${nome}"?</p>
          <div class="modal-buttons">
            <button class="btn-retornar" id="btnCancelarModal">Cancelar</button>
            <button class="btn-excluir" id="btnConfirmarExcluir">Excluir</button>
          </div>
        </div>
      `;
      modalOverlay.style.display = 'flex';
      document.getElementById('btnCancelarModal').addEventListener('click', hideModal);
      document.getElementById('btnConfirmarExcluir').addEventListener('click', () => excluirAlimento(id));
    }
    
    function hideModal() {
      modalOverlay.style.display = 'none';
    }

    // Listener para o campo de busca
    searchBar.addEventListener('input', (e) => {
      filtrarAlimentos(e.target.value);
    });

    // Listener para o botão de voltar ao menu
    btnVoltarMenu.addEventListener('click', () => {
      window.location.href = 'menu.html';
    });
  </script>
</body>
</html>
