<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Meus Dados - DMTool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Estilos gerais baseados em menu.html */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9fafb;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: #2563eb;
      color: white;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    #nomeUsuario {
      font-size: 14px;
      opacity: 0.8;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 20px;
    }

    /* Estilos do formulário e componentes de meusDados.html */
    .container {
      background: white;
      padding: 20px;
      max-width: 600px;
      width: 100%;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    label {
      margin-top: 15px;
      display: block;
      font-weight: bold;
      color: #555;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    input[disabled] {
      background-color: #e9ecef;
      cursor: not-allowed;
    }

    button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
    }

    button:hover {
      background-color: #1e40af;
      transform: translateY(-2px);
    }

    .hidden {
      display: none;
    }

    .switch-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 15px;
      padding: 8px 0;
    }

    .switch-label {
      font-weight: bold;
      color: #555;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 28px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #10b981;
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .btn-cancelar {
      background-color: #6b7280;
      margin-top: 10px;
    }

    .btn-cancelar:hover {
      background-color: #374151;
    }
  </style>
</head>
<body>
  <header>
    <h1>DMTool</h1>
    <div id="nomeUsuario">Carregando...</div>
  </header>

  <main>
    <div class="container">
      <h2>Meus Dados</h2>
      <div id="loading" class="loading-spinner"></div>
      <form id="dadosForm" class="hidden">
        <label for="nome">Nome completo</label>
        <input type="text" id="nome" required />

        <label for="cpf">CPF</label>
        <input type="text" id="cpf" disabled />

        <label for="nascimento">Data de nascimento</label>
        <input type="date" id="nascimento" required />

        <label for="telefone">Telefone com WhatsApp</label>
        <input type="text" id="telefone" required />

        <label for="email">E-mail</label>
        <input type="email" id="email" disabled />

        <div class="switch-container">
          <span class="switch-label">É paciente DM?</span>
          <label class="switch">
            <input type="checkbox" id="isDM">
            <span class="slider"></span>
          </label>
        </div>

        <div id="dmCampos" class="hidden">
          <label for="dosagemDaCaneta">Dosagem da caneta(1 ou 0.5)</label>
          <input type="number" id="dosagemDaCaneta" step="0.1" />

          <label for="glicemiaAlvo">Glicemia alvo</label>
          <input type="number" id="glicemiaAlvo" step="0.1" />

          <label for="fatorCorrecao">Fator de correção (sensibilidade)</label>
          <input type="number" id="fatorCorrecao" step="0.1" />

          <label for="doseMaxima">Dose máxima de correção (UI)</label>
          <input type="number" id="doseMaxima" step="0.1" />

          <label for="proporcaoPadrao">Proporção padrão (CHO para 1 UI)</label>
          <input type="number" id="proporcaoPadrao" step="0.1" />

          <div class="switch-container">
            <span class="switch-label">Usar proporções diferentes por refeição</span>
            <label class="switch">
              <input type="checkbox" id="proporcaoPorRefeicao">
              <span class="slider"></span>
            </label>
          </div>

          <div id="refeicoesCampos" class="hidden">
            <label for="refCafe">Proporção - Café da manhã</label>
            <input type="number" id="refCafe" step="0.1" />
            <label for="refLancheManha">Proporção - Lanche da manhã</label>
            <input type="number" id="refLancheManha" step="0.1" />
            <label for="refAlmoco">Proporção - Almoço</label>
            <input type="number" id="refAlmoco" step="0.1" />
            <label for="refLancheTarde">Proporção - Lanche da tarde</label>
            <input type="number" id="refLancheTarde" step="0.1" />
            <label for="refJantar">Proporção - Jantar</label>
            <input type="number" id="refJantar" step="0.1" />
            <label for="refCeia">Proporção - Ceia</label>
            <input type="number" id="refCeia" step="0.1" />
            <label for="refLancheAvulso">Proporção - Lanche Avulso</label>
            <input type="number" id="refLancheAvulso" step="0.1" />
            <label for="refSobremesa">Proporção - Sobremesa</label>
            <input type="number" id="refSobremesa" step="0.1" />
          </div>
        </div>

        <button type="submit">Salvar Alterações</button>
        <button type="button" class="btn-cancelar" onclick="window.location.href='menu.html'">Voltar</button>
      </form>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Configuração do Firebase. Substitua estes valores pelos do seu projeto.
    const firebaseConfig = {
      apiKey: "AIzaSyBjyWDtsSTa8Wb162xFujBt_q3KfKlOP98",
      authDomain: "dmtool-89d0d.firebaseapp.com",
      projectId: "dmtool-89d0d",
      storageBucket: "dmtool-89d0d.firebasestorage.app",
      messagingSenderId: "389362217807",
      appId: "1:389362217807:web:2805220ee73ce3c0c28b3a"
    };
    firebase.initializeApp(firebaseConfig);

    // Variáveis globais para os serviços do Firebase
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Referências aos elementos do DOM
    const nomeUsuarioHeader = document.getElementById('nomeUsuario');
    const dadosForm = document.getElementById('dadosForm');
    const loading = document.getElementById('loading');
    const nomeInput = document.getElementById('nome');
    const cpfInput = document.getElementById('cpf');
    const nascimentoInput = document.getElementById('nascimento');
    const telefoneInput = document.getElementById('telefone');
    const emailInput = document.getElementById('email');
    const isDMCheckbox = document.getElementById('isDM');
    const dmCamposDiv = document.getElementById('dmCampos');
    const dosagemDaCanetaInput = document.getElementById('dosagemDaCaneta'); // Novo campo
    const glicemiaAlvoInput = document.getElementById('glicemiaAlvo');
    const fatorCorrecaoInput = document.getElementById('fatorCorrecao');
    const doseMaximaInput = document.getElementById('doseMaxima');
    const proporcaoPadraoInput = document.getElementById('proporcaoPadrao');
    const proporcaoPorRefeicaoCheckbox = document.getElementById('proporcaoPorRefeicao');
    const refeicoesCamposDiv = document.getElementById('refeicoesCampos');
    const refCafeInput = document.getElementById('refCafe');
    const refLancheManhaInput = document.getElementById('refLancheManha');
    const refAlmocoInput = document.getElementById('refAlmoco');
    const refLancheTardeInput = document.getElementById('refLancheTarde');
    const refJantarInput = document.getElementById('refJantar');
    const refCeiaInput = document.getElementById('refCeia');
    const refLancheAvulsoInput = document.getElementById('refLancheAvulso'); // Novo campo
    const refSobremesaInput = document.getElementById('refSobremesa'); // Novo campo

    // Listener para o estado de autenticação do Firebase
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await carregarDados(user.uid);
      } else {
        alert("Nenhum usuário logado. Redirecionando para a página de login.");
        window.location.href = "./login/login.html";
      }
    });

    // Função para carregar os dados do usuário do Firestore
    async function carregarDados(uid) {
      try {
        const doc = await db.collection('usuarios').doc(uid).get();
        if (doc.exists) {
          const userData = doc.data();
          nomeUsuarioHeader.innerText = userData.nome || "Usuário";
          preencherFormulario(userData);
        } else {
          alert("Dados do usuário não encontrados. Verifique as regras do Firestore.");
        }
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        alert("Erro ao carregar dados do usuário: " + error.message);
      } finally {
        loading.classList.add('hidden');
        dadosForm.classList.remove('hidden');
      }
    }

    // Função para preencher o formulário com os dados carregados
    function preencherFormulario(userData) {
      nomeInput.value = userData.nome || '';
      cpfInput.value = userData.cpf || '';
      nascimentoInput.value = userData.nascimento || '';
      telefoneInput.value = userData.telefone || '';
      emailInput.value = userData.email || '';
      
      // Carrega e exibe os dados de DM
      isDMCheckbox.checked = userData.isDM || false;
      dmCamposDiv.classList.toggle('hidden', !isDMCheckbox.checked);

      if (isDMCheckbox.checked) {
        dosagemDaCanetaInput.value = userData.dosagemDaCaneta || '';
        glicemiaAlvoInput.value = userData.glicemiaAlvo || '';
        fatorCorrecaoInput.value = userData.fatorCorrecao || '';
        doseMaximaInput.value = userData.doseMaxima || '';
        proporcaoPadraoInput.value = userData.proporcaoPadrao || '';

        // Carrega e exibe as proporções de refeição
        proporcaoPorRefeicaoCheckbox.checked = userData.proporcaoPorRefeicao || false;
        refeicoesCamposDiv.classList.toggle('hidden', !proporcaoPorRefeicaoCheckbox.checked);

        if (proporcaoPorRefeicaoCheckbox.checked && userData.proporcoes) {
          refCafeInput.value = userData.proporcoes.cafe || '';
          refLancheManhaInput.value = userData.proporcoes.lancheManha || '';
          refAlmocoInput.value = userData.proporcoes.almoco || '';
          refLancheTardeInput.value = userData.proporcoes.lancheTarde || '';
          refJantarInput.value = userData.proporcoes.jantar || '';
          refCeiaInput.value = userData.proporcoes.ceia || '';
          refLancheAvulsoInput.value = userData.proporcoes.lancheAvulso || '';
          refSobremesaInput.value = userData.proporcoes.sobremesa || '';
        }
      }
    }

    // Listener para o checkbox "É paciente DM?"
    isDMCheckbox.addEventListener('change', () => {
      dmCamposDiv.classList.toggle('hidden', !isDMCheckbox.checked);
      if (!isDMCheckbox.checked) {
        dosagemDaCanetaInput.value = '';
        glicemiaAlvoInput.value = '';
        fatorCorrecaoInput.value = '';
        doseMaximaInput.value = '';
        proporcaoPadraoInput.value = '';
        proporcaoPorRefeicaoCheckbox.checked = false;
        refeicoesCamposDiv.classList.add('hidden');
      }
    });

    // Listener para o checkbox "Usar proporções diferentes por refeição"
    proporcaoPorRefeicaoCheckbox.addEventListener('change', () => {
      refeicoesCamposDiv.classList.toggle('hidden', !proporcaoPorRefeicaoCheckbox.checked);
      if (!proporcaoPorRefeicaoCheckbox.checked) {
        refCafeInput.value = '';
        refLancheManhaInput.value = '';
        refAlmocoInput.value = '';
        refLancheTardeInput.value = '';
        refJantarInput.value = '';
        refCeiaInput.value = '';
        refLancheAvulsoInput.value = '';
        refSobremesaInput.value = '';
      }
    });

    // Listener para o formulário de atualização
    dadosForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const user = auth.currentUser;
      if (!user) {
        alert("Nenhum usuário logado.");
        return;
      }
      
      const uid = user.uid;
      const dadosAtualizados = {
        nome: nomeInput.value,
        nascimento: nascimentoInput.value,
        telefone: telefoneInput.value,
        isDM: isDMCheckbox.checked
      };

      if (isDMCheckbox.checked) {
        dadosAtualizados.dosagemDaCaneta = parseFloat(dosagemDaCanetaInput.value) || 0;
        dadosAtualizados.glicemiaAlvo = parseFloat(glicemiaAlvoInput.value) || 0;
        dadosAtualizados.fatorCorrecao = parseFloat(fatorCorrecaoInput.value) || 0;
        dadosAtualizados.doseMaxima = parseFloat(doseMaximaInput.value) || 0;
        dadosAtualizados.proporcaoPadrao = parseFloat(proporcaoPadraoInput.value) || 0;
        dadosAtualizados.proporcaoPorRefeicao = proporcaoPorRefeicaoCheckbox.checked;

        if (proporcaoPorRefeicaoCheckbox.checked) {
          dadosAtualizados.proporcoes = {
            cafe: parseFloat(refCafeInput.value) || 0,
            lancheManha: parseFloat(refLancheManhaInput.value) || 0,
            almoco: parseFloat(refAlmocoInput.value) || 0,
            lancheTarde: parseFloat(refLancheTardeInput.value) || 0,
            jantar: parseFloat(refJantarInput.value) || 0,
            ceia: parseFloat(refCeiaInput.value) || 0,
            lancheAvulso: parseFloat(refLancheAvulsoInput.value) || 0,
            sobremesa: parseFloat(refSobremesaInput.value) || 0,
          };
        } else {
          dadosAtualizados.proporcoes = null;
        }
      } else {
        // Se não for DM, remove os campos para evitar dados desnecessários no banco de dados
        dadosAtualizados.dosagemDaCaneta = null;
        dadosAtualizados.glicemiaAlvo = null;
        dadosAtualizados.fatorCorrecao = null;
        dadosAtualizados.doseMaxima = null;
        dadosAtualizados.proporcaoPadrao = null;
        dadosAtualizados.proporcaoPorRefeicao = false;
        dadosAtualizados.proporcoes = null;
      }

      try {
        await db.collection('usuarios').doc(uid).update(dadosAtualizados);
        alert("Dados atualizados com sucesso!");
      } catch (error) {
        console.error("Erro ao atualizar dados:", error);
        alert("Erro ao atualizar dados: " + error.message);
      }
    });
  </script>
</body>
</html>